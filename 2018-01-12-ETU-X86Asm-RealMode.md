
计算机是所有软件的基础，了解基础才能更好学习其他的内容，这里推荐一本书，李忠老师的《穿越计算机的迷雾》，它可以作为非计算机专业看的计算机原理书籍，也可以作为了解计算机发展的历史。这本书用通俗易懂的语言讲述了计算机从何而来，以及计算机最基本的原理。

再一本还是李忠老师的书，书名是《X86汇编语言-从实模式到保护模式》。它是一本讲计算机汇编语言的书籍，以NASM开源汇编器为编译工具。除了汇编语言以外，李忠老师详细讲解了实模式与保护模式，以及保护模式下的分段机制，分页机制，任务等CPU功能，这些内容的讲述为学习操作系统原理可以打下良好的基础。

这两本书都属于通俗易懂的书籍，非常推荐对计算机基础原理感兴趣而又不知从何处开始学习的人阅读。
<!-- more -->
这里将学习《X86汇编语言》中的一些心得做个简单记录，对这本书有兴趣的建议阅读全书。

#### 磁盘相关 ####

关于BIOS的内容以及BIOS加载引导扇区的内容不在这里记录了，之前记录了很多相关内容了。BIOS最后会将MBR，即引导设备的第一个扇区加载到0x7C00地址处，然后跳转到MBR继续执行。所以后面编程内容基本是从内存0x7C00处的MBR开始和开展。

磁盘作为计算机不可或缺的设备之一，之前对于磁盘的理解总不够深刻，通过本书有了比较深入的理解。如下图为一般的磁盘设备的结构。

![1. 磁盘结构](2018-01-12-ETU-X86Asm-RealMode-DiskStruct.jpg)

磁盘的几个相关概念分别是磁头，盘面，磁道，柱面，扇区。在磁盘读取数据时，首先选择磁头，然后找到要读的磁道，最后盘面转到相应的扇区后，读出数据。盘片是固定的，所以一个盘片需要两个磁头，磁头臂运动后可以将磁头对准不同的磁道，盘面和磁头其实是一一对应的；片面上每一圈为一条磁道，盘面上从外到里被划分为一条条磁道；每条磁道又被划分成若干段，每一段是一个扇区。如果有多个盘片，多个盘面的同一个位置的磁道就形成了一个圆柱，被称为一个柱面。这样就形成了一圈扇区形成一个磁道，上下多个磁道形成一个柱面，所有柱面则形成了整个磁盘。编码从最外层的柱面开始，编码为0柱面，按照磁头排序，0号磁头对应的盘面上的0号柱面的磁道就是最早访问的磁道，该磁道上的第一个开始写数据的扇区被编码为1扇区。即硬盘的0面0道1扇区就是硬盘的第一个扇区，也即主引导扇区。如果将磁盘作为引导设备，那么这个扇区的512字节将被加载到内存的0x0000:0x7C00位置上，BIOS执行完毕后就会跳转到这个地址上继续运行。

上面说的按照磁头，磁道和扇区访问磁盘的方法为CHS模式，这个方式不是很方便，后来引入了逻辑块地址（Logical Block Address，LBA）的概念，LBA模式是磁盘控制器在硬件一级提供的支持，效率很高，兼容性也好。LBA不考虑扇区的物理位置，而是将全部的扇区组织起来并统一编号，这个编号从逻辑0号扇区开始。如下是一个CHS模式和LBA模式扇区的对应关系。

![2. LBA对应CHS](2018-01-12-ETU-X86Asm-RealMode-LBA-To-CHS.jpg)

所以CHS到LBA的一个对应关系如下，C为柱面号，H为磁头号或盘面号，S为扇区号。这里有一个S-1，因为CHS中S的编号从1开始而LBA的扇区号从0开始，所以要减去1。

```
	LBA = C x 磁头总数 x 每道扇区数 + H x 每道扇区数 + （S - 1）
```

作者在进行代码验证时使用VirtualBox和Bochs，硬盘用VHD虚拟硬盘。这个格式作者有详细介绍，可以参考书附件中所带的该磁盘格式的说明。我个人向用Bochs所生成的`*.img`格式，一方面可以直接用于调试，另外也不依赖作者的工具必须写到VHD格式磁盘中。有一些人可能不知道怎么搞Bochs默认的`*.img`，参考Bochs创建磁盘的说明，先img中写数据可以使用dd工具，在github上有对应的代码可以参考。

#### 显示相关 ####

实模式下显示文字比较简单，在实模式下显示为`80x25`的屏幕，一屏显示2000个字符，每个字符占据两个字节，一个字节为字符的ASCII码，另外一个字节为字符的颜色。视频显示的内存被映射到0xB800～0xBFFFF这段物理内存中，要想在屏幕上显示字符，直接修改0xB800处的内存即可。

![3. 显存映射](2018-01-12-ETU-X86Asm-RealMode-VideoMem.jpg)

如图2所示为显存和显示器上字符的对应关系，以及字符颜色字节的各位的意义。图3为字符所能设置的所有颜色种类以及各颜色对应的值。

![4. 字符颜色](2018-01-12-ETU-X86Asm-RealMode-Char-Colors.jpg)

如图3所示，在显存中低字节为字符，高字节为字符颜色。要想从屏幕左上角依次显示字符，则按照word的形式依次填充缓存即可。

#### Bochs调试 ####

单步执行 s / step

继续执行 c / continue

物理地址断点 b / break

虚拟地址断点 vb /vbreak

显示寄存器 r

显示段寄存器 sreg

显示物理地址 xp   xp /nfb

退出调试 q / quit



#### NASM汇编 ####

** 数据声明 **

db，dw，dd，dq 分别表示定义字节，字，双字，四字的数据，这些数据会在编译后占据真实的空间。如：

```
db 0x55, 0xaa       ; 引导扇区结尾标识定义

number db 0,0,0,0,0 ; 标号number引用变量，五个字节数据并初始化为0
```

times伪指令可以重复定义数据/指令若干次

```
times 20 mov ax, bx 	; 重复mov ax, bx语句20次

times 203 db 0          ; 保留203个为0的字节
```

** $$与$ **

$代表当前行地址，而$$代表当前程序的起始地址，所以 jmp $ 相当于跳转到当前行，即死循环等价于 `infi: jmp near infi`

** 相对跳转的计算 **

E8跳转中，其后的相对偏移值按照如下的方式计算：

```
相对偏移 = 目标地址 - 跳转指令地址 - 跳转指令长度
```


By Andy @2018-01-12 11:20:38
